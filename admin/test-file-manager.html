<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager Test - Jekyll Admin</title>
    <link rel="stylesheet" href="assets/css/admin.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-header {
            background: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .test-title {
            margin: 0;
            color: #333;
            font-size: 1.5rem;
        }
        
        .test-description {
            margin: 0.5rem 0 0 0;
            color: #666;
            font-size: 0.875rem;
        }
        
        .test-controls {
            background: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .control-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-label {
            font-weight: 500;
            color: #333;
            min-width: 120px;
        }
        
        .status-display {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-supported {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-not-supported {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1 class="test-title">파일 관리자 테스트</h1>
        <p class="test-description">
            FileSystemManager와 FileManagerUI 컴포넌트의 기능을 테스트합니다.
            File System Access API 지원 여부에 따라 다른 동작을 확인할 수 있습니다.
        </p>
    </div>
    
    <div class="test-controls">
        <div class="control-group">
            <span class="control-label">브라우저 지원:</span>
            <div id="browser-support" class="status-display">확인 중...</div>
        </div>
        
        <div class="control-group">
            <span class="control-label">파일 시스템 상태:</span>
            <div id="filesystem-status" class="status-display">초기화 중...</div>
        </div>
        
        <div class="control-group">
            <span class="control-label">테스트 작업:</span>
            <div style="display: flex; gap: 0.5rem;">
                <button id="test-create-file" class="btn btn-outline btn-sm">테스트 파일 생성</button>
                <button id="test-read-file" class="btn btn-outline btn-sm">파일 읽기 테스트</button>
                <button id="reset-test" class="btn btn-outline btn-sm">테스트 초기화</button>
            </div>
        </div>
    </div>
    
    <div id="file-manager-container">
        <!-- FileManagerUI will be rendered here -->
    </div>
    
    <script type="module">
        import { FileSystemManager } from './assets/js/modules/file-system-manager.js';
        import { FileManagerUI } from './assets/js/modules/file-manager-ui.js';
        
        // 전역 변수
        let fileSystemManager;
        let fileManagerUI;
        
        // 초기화
        async function init() {
            console.log('파일 관리자 테스트 초기화 시작');
            
            try {
                // FileSystemManager 초기화
                fileSystemManager = new FileSystemManager();
                const initSuccess = await fileSystemManager.init();
                
                if (!initSuccess) {
                    throw new Error('FileSystemManager 초기화 실패');
                }
                
                // FileManagerUI 초기화
                const container = document.getElementById('file-manager-container');
                fileManagerUI = new FileManagerUI(fileSystemManager);
                fileManagerUI.init(container);
                
                // 상태 업데이트
                updateStatus();
                
                // 테스트 버튼 이벤트 리스너
                setupTestControls();
                
                console.log('파일 관리자 테스트 초기화 완료');
                
            } catch (error) {
                console.error('초기화 실패:', error);
                showError('초기화에 실패했습니다: ' + error.message);
            }
        }
        
        // 상태 업데이트
        function updateStatus() {
            const browserSupportEl = document.getElementById('browser-support');
            const filesystemStatusEl = document.getElementById('filesystem-status');
            
            // 브라우저 지원 상태
            const isSupported = fileSystemManager.isFileSystemAccessSupported();
            browserSupportEl.textContent = isSupported ? 'File System Access API 지원' : 'File System Access API 미지원';
            browserSupportEl.className = `status-display ${isSupported ? 'status-supported' : 'status-not-supported'}`;
            
            // 파일 시스템 상태
            const status = fileSystemManager.getStatus();
            filesystemStatusEl.textContent = status.hasRootDirectory ? '디렉토리 연결됨' : '디렉토리 미연결';
            filesystemStatusEl.className = `status-display ${status.hasRootDirectory ? 'status-supported' : 'status-not-supported'}`;
        }
        
        // 테스트 컨트롤 설정
        function setupTestControls() {
            document.getElementById('test-create-file').addEventListener('click', testCreateFile);
            document.getElementById('test-read-file').addEventListener('click', testReadFile);
            document.getElementById('reset-test').addEventListener('click', resetTest);
        }
        
        // 테스트 파일 생성
        async function testCreateFile() {
            try {
                const testContent = `---
layout: post
title: "테스트 포스트"
date: ${new Date().toISOString().slice(0, 19).replace('T', ' ')} +0900
categories: [test]
tags: [test, demo]
---

# 테스트 포스트

이것은 파일 관리자 테스트를 위한 샘플 포스트입니다.

## 기능 테스트

- 파일 생성 ✅
- 마크다운 렌더링
- Front matter 파싱

생성 시간: ${new Date().toLocaleString('ko-KR')}
`;
                
                const filename = `test-post-${Date.now()}.markdown`;
                
                console.log('테스트 파일 생성 시도:', filename);
                
                const success = await fileSystemManager.writeFile(filename, testContent, 'posts');
                
                if (success) {
                    showSuccess(`테스트 파일 "${filename}"이 생성되었습니다.`);
                    // UI 새로고침
                    if (fileManagerUI) {
                        fileManagerUI.refreshFileList();
                    }
                } else {
                    throw new Error('파일 생성 실패');
                }
                
            } catch (error) {
                console.error('테스트 파일 생성 실패:', error);
                showError('테스트 파일 생성에 실패했습니다: ' + error.message);
            }
        }
        
        // 파일 읽기 테스트
        async function testReadFile() {
            try {
                // 파일 목록 가져오기
                const files = await fileSystemManager.listFiles('posts');
                
                if (files.length === 0) {
                    showWarning('읽을 파일이 없습니다. 먼저 테스트 파일을 생성해주세요.');
                    return;
                }
                
                // 첫 번째 파일 읽기
                const firstFile = files[0];
                console.log('파일 읽기 시도:', firstFile.name);
                
                const content = await fileSystemManager.readFile(firstFile.name, 'posts');
                
                console.log('파일 내용:', content);
                showSuccess(`파일 "${firstFile.name}"을 성공적으로 읽었습니다. (${content.length}자)`);
                
                // 내용을 콘솔에 출력
                console.log('=== 파일 내용 ===');
                console.log(content);
                console.log('=== 파일 내용 끝 ===');
                
            } catch (error) {
                console.error('파일 읽기 실패:', error);
                showError('파일 읽기에 실패했습니다: ' + error.message);
            }
        }
        
        // 테스트 초기화
        async function resetTest() {
            try {
                console.log('테스트 초기화');
                
                // FileManagerUI 새로고침
                if (fileManagerUI) {
                    fileManagerUI.updateStatus();
                    await fileManagerUI.refreshFileList();
                }
                
                showInfo('테스트가 초기화되었습니다.');
                
            } catch (error) {
                console.error('테스트 초기화 실패:', error);
                showError('테스트 초기화에 실패했습니다: ' + error.message);
            }
        }
        
        // 메시지 표시 함수들
        function showSuccess(message) {
            showMessage(message, 'success');
        }
        
        function showError(message) {
            showMessage(message, 'error');
        }
        
        function showWarning(message) {
            showMessage(message, 'warning');
        }
        
        function showInfo(message) {
            showMessage(message, 'info');
        }
        
        function showMessage(message, type) {
            // 간단한 토스트 메시지 구현
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            // 스타일 적용
            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '12px 20px',
                borderRadius: '6px',
                color: 'white',
                fontWeight: '500',
                zIndex: '10000',
                maxWidth: '400px',
                wordWrap: 'break-word'
            });
            
            // 타입별 배경색
            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };
            
            toast.style.backgroundColor = colors[type] || colors.info;
            
            document.body.appendChild(toast);
            
            // 3초 후 제거
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
            
            // 콘솔에도 출력
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);
        
        // 전역 접근을 위한 window 객체에 할당
        window.fileSystemManager = fileSystemManager;
        window.fileManagerUI = fileManagerUI;
        
    </script>
</body>
</html>